<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Buy Tickets</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<!-- Load Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<script type="module">
  import { db } from "./auth.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  function getEventId() {
    const params = new URLSearchParams(window.location.search);
    return params.get('id');
  }

  async function loadTicketTypes() {
    const eventId = getEventId();
    if (!eventId) return;

    const docRef = doc(db, "events", eventId);
    const docSnap = await getDoc(docRef);

    const ticketContainer = document.getElementById("ticketInputs");
    ticketContainer.innerHTML = "";

    if (docSnap.exists()) {
      const event = docSnap.data();
      document.getElementById("eventTitle").textContent = event.title || "Select Your Tickets";
      
      if (event.ticketTypes && Array.isArray(event.ticketTypes)) {
        event.ticketTypes.forEach((ticket, idx) => {
          const div = document.createElement("div");
          div.className = "ticket-input";
          div.innerHTML = `
            <div class="ticket-row">
              <div class="ticket-info">
                <strong>${ticket.name}</strong> - ${ticket.price} LKR
              </div>
              <div class="ticket-controls">
                <button type="button" onclick="changeQuantity(${idx}, -1)">-</button>
                <input type="number" id="ticket_${idx}" min="0" value="0">
                <button type="button" onclick="changeQuantity(${idx}, 1)">+</button>
              </div>
            </div>
          `;
          ticketContainer.appendChild(div);
        });
      } else {
        ticketContainer.innerHTML = "<p>No tickets available</p>";
      }
    } else {
      ticketContainer.innerHTML = "<p>Event not found</p>";
    }

    updateTotal();
  }

  window.loadTicketTypes = loadTicketTypes;
  window.getEventId = getEventId;
</script>

<style>
body {
  font-family: 'Poppins', sans-serif;
  background: #0a0a0a;
  color: #fff;
  margin: 0;
  padding: 20px;
}
h1 { text-align: center; color: #00ffcc; margin-bottom: 20px; }
.form-container {
  background: #111;
  max-width: 500px;
  margin: auto;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 20px rgba(0,255,204,0.3);
}
input[type="text"], input[type="email"] {
  width: 100%;
  padding: 12px;
  margin: 10px 0;
  border-radius: 8px;
  border: none;
  background: #222;
  color: #fff;
  font-size: 16px;
}
.ticket-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #1b1b1b;
  padding: 10px;
  margin: 8px 0;
  border-radius: 8px;
}
.ticket-info { font-size: 16px; }
.ticket-controls {
  display: flex;
  align-items: center;
  gap: 5px;
}
.ticket-controls input {
  width: 50px;
  text-align: center;
  font-size: 16px;
}
.ticket-controls button {
  padding: 6px 12px;
  font-size: 16px;
  font-weight: 600;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: #00ffcc;
  color: #000;
  transition: 0.2s;
}
.ticket-controls button:hover {
  background: #00cc99;
}
#totalAmount {
  margin-top: 10px;
  font-size: 18px;
  font-weight: bold;
  text-align: right;
  color: #00ffcc;
}
button#checkout-button, button#refresh {
  width: 100%;
  padding: 12px;
  margin-top: 15px;
  font-weight: bold;
  font-size: 16px;
  cursor: pointer;
  border-radius: 8px;
  border: none;
  background: #00ffcc;
  color: #000;
  transition: 0.2s;
}
button#checkout-button:hover, button#refresh:hover {
  background: #00cc99;
}
#qrcode {
  margin-top: 20px;
  text-align: center;
  min-height: 260px;
  border: 2px dashed #00ffcc;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  color: #00ffcc;
  border-radius: 12px;
}
#debugOutput {
  margin-top: 20px;
  color: #0f0;
  font-size: 14px;
  word-break: break-word;
}
.loading {
  display: none;
  text-align: center;
  margin-top: 20px;
  color: #00ffcc;
}
</style>

<body onload="loadTicketTypes()">
<h1 id="eventTitle">Select Your Tickets</h1>
<div class="form-container">
  <input type="text" id="name" placeholder="Your Name" required>
  <input type="email" id="email" placeholder="Your Email" required>

  <div id="ticketInputs"></div>
  <div id="totalAmount">Total: 0 LKR</div>

  <button id="checkout-button">Proceed to Payment</button>
  <button id="refresh" onclick="refreshForm()">Reset</button>
</div>

<div id="qrcode">QR will appear here</div>
<div id="debugOutput"></div>
<div id="loading" class="loading">Processing payment...</div>

<script>
// Initialize Stripe with your publishable key
const stripe = Stripe('pk_test_51R9V5a4ZyAT5oIFLWNLCaQGO9WtFk3pSalJHz2Ly8YdKIiN8uIcibensYmf3sgwS2r5siU1QfkDGN5TY7cwedEVM00tOkiExkW'); // Replace with your actual key

// Import Firebase functions for use in the global scope
let getDoc, doc;
import("https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js")
  .then((firestoreModule) => {
    getDoc = firestoreModule.getDoc;
    doc = firestoreModule.doc;
  })
  .catch((error) => {
    console.error("Error importing Firebase modules:", error);
  });

window.changeQuantity = function(idx, delta) {
  const input = document.getElementById(`ticket_${idx}`);
  let val = parseInt(input.value) || 0;
  val += delta;
  if (val < 0) val = 0;
  input.value = val;
  updateTotal();
}

window.updateTotal = function() {
  const ticketRows = document.querySelectorAll(".ticket-row");
  let total = 0;
  ticketRows.forEach(row => {
    const quantityInput = row.querySelector("input");
    const quantity = parseInt(quantityInput.value) || 0;
    if (quantity > 0) {
      const priceText = row.querySelector(".ticket-info").innerText.split(" - ")[1];
      const price = parseInt(priceText) || 0;
      total += quantity * price;
    }
  });
  document.getElementById("totalAmount").innerText = `Total: ${total} LKR`;
  return total;
}

// Set up Stripe Checkout
document.getElementById('checkout-button').addEventListener('click', async () => {
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const eventId = getEventId();
  const totalAmount = updateTotal();

  if (!name || !email) {
    alert("Please fill in all fields.");
    return;
  }

  if (totalAmount <= 0) {
    alert("Please select at least one ticket.");
    return;
  }

  // Show loading state
  document.getElementById("loading").style.display = "block";
  document.getElementById("checkout-button").disabled = true;

  try {
    // Get event data
    const eventDoc = await getDoc(doc(db, "events", eventId));
    if (!eventDoc.exists()) {
      throw new Error("Event not found");
    }

    const event = eventDoc.data();
    
    // Prepare line items for Stripe checkout
    const lineItems = [];
    document.querySelectorAll(".ticket-row").forEach((row, idx) => {
      const quantity = parseInt(row.querySelector("input").value) || 0;
      if (quantity > 0) {
        const label = row.querySelector(".ticket-info").innerText.split(" - ")[0];
        const priceText = row.querySelector(".ticket-info").innerText.split(" - ")[1];
        const price = parseInt(priceText) || 0;
        
        // Create line item with custom price
        lineItems.push({
          price_data: {
            currency: 'lkr',
            product_data: {
              name: `${event.title} - ${label}`,
              description: `Ticket for ${event.title} at ${event.venue || 'Unknown venue'} on ${event.date || 'unknown date'}`,
            },
            unit_amount: price * 100, // Convert to cents
          },
          quantity: quantity,
        });
      }
    });

    // Create checkout session directly from client (using Stripe's client-only integration)
    const { error } = await stripe.redirectToCheckout({
      lineItems: lineItems,
      mode: 'payment',
      successUrl: `${window.location.origin}/success.html?eventId=${eventId}&name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}`,
      cancelUrl: `${window.location.origin}/cancel.html`,
      customerEmail: email,
    });

    if (error) {
      console.error('Error:', error);
      alert('Error processing payment: ' + error.message);
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error processing payment: ' + error.message);
  } finally {
    document.getElementById("loading").style.display = "none";
    document.getElementById("checkout-button").disabled = false;
  }
});

function encrypt(ticketData) {
  const AES_KEY = 'Wagasenevi123456';
  const key = CryptoJS.enc.Utf8.parse(AES_KEY);
  const plaintext = CryptoJS.enc.Utf8.parse(ticketData);
  const encrypted = CryptoJS.AES.encrypt(plaintext, key, {
    mode: CryptoJS.mode.ECB,
    padding: CryptoJS.pad.Pkcs7,
  });
  return encrypted.toString().replace(/\n/g, '');
}

function decrypt(encryptedData) {
  const AES_KEY = 'Wagasenevi123456';
  const key = CryptoJS.enc.Utf8.parse(AES_KEY);
  const decrypted = CryptoJS.AES.decrypt(encryptedData, key, {
    mode: CryptoJS.mode.ECB,
    padding: CryptoJS.pad.Pkcs7,
  });
  return CryptoJS.enc.Utf8.stringify(decrypted);
}

window.refreshForm = function() {
  document.getElementById("name").value = '';
  document.getElementById("email").value = '';
  document.querySelectorAll("#ticketInputs input").forEach(input => input.value = 0);
  updateTotal();
  const qrcodeDiv = document.getElementById("qrcode");
  qrcodeDiv.innerHTML = "QR will appear here";
  document.getElementById("debugOutput").innerText = '';
}

document.addEventListener('input', updateTotal);
</script>
</body>
</html>