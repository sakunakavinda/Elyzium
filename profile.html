<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Account - Elyzium</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

  body {
    background: black;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    padding: 30px 15px;
  }

  .container {
    max-width: 900px;
    width: 100%;
    background: #171717;
    border-radius: 20px;
    box-shadow: 0 12px 28px rgba(0,0,0,0.12);
    padding: 40px 35px;
    display: flex;
    flex-direction: column;
    gap: 35px;
    transition: all 0.3s ease;
  }

  h1 {
    text-align: center;
    color: #ececec;
    font-size: 2.2rem;
    font-weight: 700;
  }

  .profile-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
  }

  .profile-section img {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid #1d8240;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .profile-section img:hover {
    transform: scale(1.08);
    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  }

  .edit-label {
    cursor: pointer;
    color: #1d8240;
    font-weight: 600;
    text-decoration: underline;
    font-size: 0.95rem;
  }

  .form-section {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  .form-group label {
    font-weight: 600;
    color: #a8a8a8;
    margin-bottom: 8px;
    font-size: 1rem;
  }

  .form-group input {
    padding: 14px 16px;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #2c2c2e;
    color: #fff;
  }

  .form-group input:focus {
    border-color: #1d8240;
    box-shadow: 0 0 5px rgba(29,130,64,0.4);
    outline: none;
  }

  .btn {
    padding: 15px 28px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
  }

  .save-btn {
    background: linear-gradient(90deg, #1d8240 0%, #23a14a 100%);
    color: #fff;
    box-shadow: 0 6px 15px rgba(29,130,64,0.3);
  }

  .save-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(29,130,64,0.4);
  }

  .logout-btn {
    background: linear-gradient(90deg, #e74c3c 0%, #ff5e4c 100%);
    color: #fff;
    margin-top: 10px;
    box-shadow: 0 6px 15px rgba(231,76,60,0.3);
  }

  .logout-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(231,76,60,0.4);
  }

  #progressContainer {
    display: none;
    width: 100%;
    background: #e0e0e0;
    border-radius: 12px;
    height: 14px;
    overflow: hidden;
    margin-bottom: 10px;
  }

  #progressBar {
    width: 0%;
    height: 100%;
    background: #1d8240;
    box-shadow: 0 2px 6px rgba(29,130,64,0.6);
    transition: width 0.3s ease;
  }

  /* Toast Notification */
  .toast {
    position: fixed;
    top: 30px;
    right: 30px;
    background: #1d8240;
    color: #fff;
    padding: 14px 22px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    opacity: 0;
    pointer-events: none;
    transition: all 0.5s ease;
    z-index: 999;
  }

  .toast.show {
    opacity: 1;
    pointer-events: auto;
  }

  @media (max-width: 768px) {
    .container { padding: 30px 25px; gap: 30px; }
    .profile-section img { width: 130px; height: 130px; }
  }

  @media (max-width: 480px) {
    .container { padding: 25px 20px; gap: 25px; }
    h1 { font-size: 1.9rem; }
    .profile-section img { width: 110px; height: 110px; }
  }
</style>
</head>
<body>

<div class="container">
  <h1>Account Settings</h1>

  <div class="profile-section">
    <img id="profilePic" src="images/default-profile.png" alt="Profile Picture">
    <label for="profileUpload" class="edit-label">Change Profile Picture</label>
    <input type="file" id="profileUpload" accept="image/*" style="display:none;">
  </div>

  <div class="form-section">
    <div class="form-group">
      <label for="name">Full Name</label>
      <input type="text" id="name" placeholder="Name">
    </div>

    <div class="form-group">
      <label for="email">Email</label>
      <input type="email" id="email" placeholder="name@example.com" readonly>
    </div>

    <div id="progressContainer">
      <div id="progressBar"></div>
    </div>

    <button class="btn save-btn">Save Changes</button>
    <button class="btn logout-btn" id="logoutBtn">Logout</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { auth, db } from "./auth.js";

const profilePic = document.getElementById('profilePic');
const profileUpload = document.getElementById('profileUpload');
const nameInput = document.getElementById('name');
const emailInput = document.getElementById('email');
const saveBtn = document.querySelector('.save-btn');
const logoutBtn = document.getElementById('logoutBtn');
const progressContainer = document.getElementById('progressContainer');
const progressBar = document.getElementById('progressBar');
const toast = document.getElementById('toast');

let currentUser = null;
let newProfileFile = null;

const showToast = (message, bg='#1d8240') => {
  toast.innerText = message;
  toast.style.background = bg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
};

onAuthStateChanged(auth, async user => {
  if(!user) return window.location.href="admin-login.html";
  currentUser = user;
  emailInput.value = user.email;
  const docRef = doc(db, "admins", user.uid);
  const docSnap = await getDoc(docRef);
  if(docSnap.exists()) {
    const data = docSnap.data();
    nameInput.value = data.name||'';
    profilePic.src = data.profilePicUrl||"images/default-profile.png";
  }
});

profileUpload.addEventListener('change', e => {
  const file = e.target.files[0];
  if(!file) return;
  newProfileFile = file;
  const reader = new FileReader();
  reader.onload = () => profilePic.src = reader.result;
  reader.readAsDataURL(file);
});

saveBtn.addEventListener('click', async () => {
  if(!currentUser) return;
  
  saveBtn.disabled = true;                // Disable button
  saveBtn.style.opacity = 0.6;            // Optional: visually indicate disabled state
  const docRef = doc(db, "admins", currentUser.uid);
  let imgUrl = null;
  progressContainer.style.display='block';
  progressBar.style.width='0%';

  try {
    if(newProfileFile){
      const formData = new FormData();
      formData.append("image", newProfileFile);

      let progress = 0;
      const interval = setInterval(() => {
        if(progress < 80) progress += 5;
        progressBar.style.width = progress + '%';
      }, 100);

      const res = await fetch(`https://api.imgbb.com/1/upload?key=b39809d92fb65ba3d028be78ec1db78c`, {
        method: 'POST',
        body: formData
      });

      clearInterval(interval);
      const result = await res.json();
      if(!result.success) throw new Error('Upload failed');
      imgUrl = result.data.url;
      progressBar.style.width = '100%';
    } else {
      progressBar.style.width = '50%';
    }

    const updateData = { name: nameInput.value };
    if(imgUrl) updateData.profilePicUrl = imgUrl;
    await updateDoc(docRef, updateData);

    progressBar.style.width = '100%';
    setTimeout(() => progressContainer.style.display = 'none', 500);
    showToast("Profile updated successfully!");
    window.location.href = "admin-dashboard.html";
  } catch(err) {
    console.error(err);
    progressContainer.style.display = 'none';
    showToast("Error updating profile", "#e74c3c");
  } finally {
    saveBtn.disabled = false;             // Re-enable button
    saveBtn.style.opacity = 1;
  }
});

logoutBtn.addEventListener('click', async()=>{
  try{
    await signOut(auth);
    window.location.href="admin-login.html";
  }catch{
    showToast("Logout failed", "#e74c3c");
  }
});

profilePic.addEventListener('click', ()=>profileUpload.click());
</script>
</body>
</html>